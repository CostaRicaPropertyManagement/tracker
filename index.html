<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Contractor Assignment Console — Executive</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#6b7280; --line:#e6e9f2;
    --brand:#2f66ff; --brand-weak:#e9f0ff; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    --chip:#f1f3f9; --shadow:0 10px 30px rgba(25,35,60,.08);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial; background:linear-gradient(180deg,#f9fbff,#f2f5fb); color:var(--ink);}
  header{position:sticky; top:0; z-index:10; background:rgba(255,255,255,.85); backdrop-filter:saturate(150%) blur(6px); border-bottom:1px solid var(--line);}
  .nav{max-width:1280px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
  .badge{font-size:12px; background:var(--brand-weak); color:var(--brand); padding:4px 8px; border:1px solid #dbe4ff; border-radius:999px}
  main{max-width:1280px; margin:24px auto 56px; padding:0 18px}
  .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:16px}
  @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow)}
  .card .hd{padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between}
  .card .bd{padding:16px}
  .h2{font-size:16px; font-weight:800; margin:0}
  .muted{color:var(--muted)}
  .row{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
  .col-12{grid-column:span 12} .col-8{grid-column:span 8} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3}
  label{display:block; font-size:12px; font-weight:700; color:var(--muted); margin:0 0 6px; letter-spacing:.2px}
  input[type="text"], select{width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; outline:none}
  input:focus, select:focus{border-color:#cbd5ff; box-shadow:0 0 0 4px #e9efff}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:700}
  .btn.primary{background:linear-gradient(180deg,#3b74ff,#2f66ff); color:#fff; border:0}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .chips{display:flex; flex-direction:column; gap:10px}
  .chip{display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; background:var(--chip); border:1px solid var(--line); padding:10px; border-radius:12px}
  .chip .right{display:flex; gap:10px; align-items:center}
  .capline{display:grid; grid-template-columns: 70px 1fr 48px; gap:8px; align-items:center}
  .capline output{font-variant-numeric: tabular-nums; text-align:right}
  .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  .kpi .tile{background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px}
  .kpi .t{margin:0 0 4px; font-size:12px; color:var(--muted)}
  .kpi .v{font-size:22px; font-weight:900}
  .progress{height:10px; background:#eef2ff; border:1px solid #dbe4ff; border-radius:999px; overflow:hidden}
  .progress .bar{height:100%; width:0%; background:linear-gradient(90deg,#87a9ff,#2f66ff)}
  table{width:100%; border-collapse:separate; border-spacing:0}
  th,td{padding:10px 12px; border-bottom:1px solid var(--line); vertical-align:top}
  th{position:sticky; top:0; background:#fff; text-align:left; color:#5b6472; font-weight:800}
  .chart{width:100%; height:172px; position:relative}
  .bar{position:absolute; bottom:0; width:28px; background:linear-gradient(180deg,#87a9ff,#2f66ff); border-radius:6px 6px 0 0}
  .bar label{position:absolute; bottom:100%; left:50%; transform:translate(-50%,-6px); font-size:11px; color:var(--muted)}
  .legend{display:flex; gap:14px; align-items:center; margin-top:8px; color:var(--muted); font-size:12px}
  .legend .key{width:12px; height:12px; border-radius:2px; background:linear-gradient(180deg,#87a9ff,#2f66ff); border:1px solid #dbe4ff}
  .pill{background:var(--chip); border:1px solid var(--line); border-radius:999px; padding:6px 10px; display:inline-flex; align-items:center; gap:8px}
  .hr{height:1px; background:linear-gradient(90deg,transparent,#e7ebf5,transparent); margin:12px 0}
  /* Board */
  .board{display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:12px}
  .lane{background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px}
  .lane .lane-hd{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
  .meter{height:8px; border-radius:999px; background:#eef2ff; border:1px solid #dbe4ff; position:relative; overflow:hidden}
  .meter .fill{position:absolute; left:0; top:0; height:100%; width:0%; background:linear-gradient(90deg,#a3d89a,#16a34a)}
  .lane .cap{font-size:12px; color:var(--muted)}
  .task{border:1px solid var(--line); background:#fbfcff; border-radius:12px; padding:10px; margin:8px 0; cursor:grab}
  .task.dragging{opacity:.6}
  .lane.drop-target{outline:2px dashed #99b7ff; outline-offset:2px}
  .right{ text-align:right; }
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3l8.66 5v8L12 21l-8.66-5V8L12 3z" stroke="#2f66ff" stroke-width="1.6" fill="#e9f0ff"/></svg>
      Contractor Assignment Console
      <span class="badge">Executive</span>
    </div>
    <div class="muted">Boardroom-grade routing & workload planning</div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT: Planner -->
    <section class="card">
      <div class="hd">
        <div class="h2">Planner</div>
        <div id="status" class="muted">Loading…</div>
      </div>
      <div class="bd">
        <div class="row">
          <div class="col-12">
            <label>Published Spreadsheet (pubhtml)</label>
            <input id="pubhtmlUrl" type="text" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRkKGxXCLnmlEvHZm6oeUjzSguxRia70_3dQuCIc58UAj9YmbMO0Vttx--4k3rai-JqqkLvfwlr8Mk5/pubhtml" />
          </div>
          <div class="col-6">
            <label>City (from sheet)</label>
            <select id="citySelect"><option value="">Loading…</option></select>
          </div>
          <div class="col-6">
            <label>Day</label>
            <select id="daySelect">
              <option value="today">Today</option>
              <option value="tomorrow">Tomorrow</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="col-6">
            <label>Contractor (from Contractors!D)</label>
            <select id="contractorSelect"><option value="">Loading…</option></select>
          </div>
          <div class="col-3">
            <label>Initial Qty</label>
            <input id="qtyInput" type="text" placeholder="e.g., 2" />
          </div>
          <div class="col-3" style="display:flex; align-items:flex-end;">
            <button id="addBtn" class="btn">Add</button>
          </div>
          <div class="col-12">
            <div id="selectedWrap" class="chips" aria-live="polite"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="col-12">
            <div style="display:flex; gap:12px; align-items:center; justify-content:space-between">
              <div class="stack">
                <button id="runBtn" class="btn primary">Run Optimization</button>
                <button id="resetBtn" class="btn">Reset</button>
              </div>
              <div style="min-width:260px;">
                <div class="progress" aria-label="Optimization progress">
                  <div id="progressBar" class="bar" style="width:0%"></div>
                </div>
                <div id="progressText" class="muted" style="text-align:right; font-size:12px; margin-top:4px;">0%</div>
              </div>
            </div>
            <div class="muted" style="margin-top:8px;">Distance Matrix used once per pairing. API key embedded.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Overview -->
    <section class="card">
      <div class="hd">
        <div class="h2">Executive Overview</div>
        <div class="stack">
          <button id="dlOptimized" class="btn" disabled>Download Optimized</button>
          <button id="dlSummary" class="btn" disabled>Download Summary</button>
          <button id="dlUnassignable" class="btn" disabled>Download Unassignable</button>
        </div>
      </div>
      <div class="bd">
        <div class="kpi" id="kpis">
          <div class="tile"><div class="t">Total Tasks</div><div class="v" id="kpiTasks">—</div></div>
          <div class="tile"><div class="t">Assigned</div><div class="v" id="kpiAssigned">—</div></div>
          <div class="tile"><div class="t">Unassignable</div><div class="v" id="kpiUn">—</div></div>
          <div class="tile"><div class="t">Contractors</div><div class="v" id="kpiHM">—</div></div>
        </div>
        <div class="hr"></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <span class="pill">Hour (Chicago): <b id="pillHour">—</b></span>
          <span class="pill">City: <b id="pillCity">—</b></span>
          <span class="pill">Day: <b id="pillDay">—</b></span>
          <span class="pill">DM Calls: <b id="pillCalls">—</b></span>
        </div>
        <div class="hr"></div>
        <div class="h2" style="margin-bottom:6px;">Distance by Contractor</div>
        <div class="chart" id="distChart"></div>
        <div class="legend"><span class="key"></span> Total travel (miles)</div>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:16px;">
    <div class="hd"><div class="h2">Assignment Board</div><div class="muted">Drag tasks between contractors (capacity-aware). Use sliders to change capacity.</div></div>
    <div class="bd">
      <div id="board" class="board"></div>
    </div>
  </section>

  <section class="card" style="margin-top:16px;">
    <div class="hd"><div class="h2">Optimized Assignments</div><div class="muted">Nearest-contractor allocation</div></div>
    <div class="bd" id="optTable"></div>
  </section>

  <section class="card" style="margin-top:16px;">
    <div class="hd"><div class="h2">Distance Summary</div><div class="muted">Travel load & route links</div></div>
    <div class="bd" id="sumTable"></div>
  </section>

  <section class="card" style="margin-top:16px;">
    <div class="hd"><div class="h2">Unassignable Units</div><div class="muted">Outside time windows or missing data</div></div>
    <div class="bd" id="unTable"></div>
  </section>
</main>

<script>
/* ===== CONFIG ===== */
const SHEET_NAMES = {
  CONTRACTORS: 'Contractors', // names in column D (index 3)
  PROPERTY: 'Property Repairs & Maintenance'
};
// Embedded Distance Matrix API key (replace if needed)
const DIST_API_KEY = "AIzaSyBCquBYPDA8je69fxnjKwM2y6tuNWNygwQ";
const TZ = 'America/Chicago';

/* ===== UTIL ===== */
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
function chicagoHourNow(){
  const parts = new Intl.DateTimeFormat('en-US',{hour:'numeric', hour12:false, timeZone:TZ}).formatToParts(new Date());
  return parseInt(parts.find(p=>p.type==='hour')?.value || '0', 10);
}
function cleanName(s){ return s ? String(s).normalize('NFKD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase() : ''; }
function getColumnMap(header){ const m={}; header.forEach((h,i)=> m[String(h).trim().toLowerCase()] = i); return m; }
function parseCSV(text){
  const rows=[]; let cur=[]; let val=''; let inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQ){
      if(ch==='"' && text[i+1]==='"'){ val+='"'; i++; continue; }
      if(ch==='"'){ inQ=false; continue; }
      val+=ch;
    }else{
      if(ch==='"'){ inQ=true; continue; }
      if(ch===','){ cur.push(val); val=''; continue; }
      if(ch==='\n'){ cur.push(val); rows.push(cur); cur=[]; val=''; continue; }
      if(ch==='\r'){ continue; }
      val+=ch;
    }
  }
  cur.push(val); rows.push(cur);
  return rows;
}
function table(containerId, headers, rows){
  const el=document.getElementById(containerId);
  if(!rows.length){ el.innerHTML='<div class="muted">No rows.</div>'; return; }
  let html = '<div style="overflow:auto; max-height:460px; border:1px solid var(--line); border-radius:12px;"><table><thead><tr>';
  html += headers.map(h=>`<th>${h}</th>`).join('');
  html += '</tr></thead><tbody>';
  html += rows.map(r=>'<tr>'+r.map(c=>`<td>${c==null?'':c}</td>`).join('')+'</tr>').join('');
  html += '</tbody></table></div>';
  el.innerHTML=html;
}
function toCSV(headers, rows){
  const esc=v=>{ const s=v==null?'':String(v); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; };
  return [headers.map(esc).join(','), ...rows.map(r=>r.map(esc).join(','))].join('\n');
}
function downloadCSV(filename, headers, rows){
  const blob=new Blob([toCSV(headers,rows)],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
function setStatus(t){ document.getElementById('status').textContent=t; }
function setProgress(pct){
  const bar=document.getElementById('progressBar');
  const txt=document.getElementById('progressText');
  bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
  txt.textContent = Math.round(Math.max(0, Math.min(100, pct))) + '%';
}

/* ===== SHEET LOADING ===== */
function extractDocIdFromPubhtml(url){
  const m=url.match(/\/spreadsheets\/d\/e\/([^/]+)\/pubhtml/i);
  if(!m) throw new Error('Invalid pubhtml URL');
  return m[1];
}
async function fetchGids(pubhtmlUrl){
  const res = await fetch(pubhtmlUrl, {mode:'cors'});
  const html = await res.text();
  const map={}; let m; const re=/#gid=(\d+)".*?>([^<]+)<\/a>/g;
  while((m=re.exec(html))!==null){ map[m[2].trim()]=m[1]; }
  if(!Object.keys(map).length) throw new Error('No tabs found in pubhtml.');
  return map;
}
async function fetchCSVByGid(docId, gid){
  const url=`https://docs.google.com/spreadsheets/d/e/${docId}/pub?gid=${encodeURIComponent(gid)}&single=true&output=csv`;
  const res=await fetch(url, {mode:'cors'});
  if(!res.ok) throw new Error('CSV fetch failed: '+res.status);
  return parseCSV(await res.text());
}

/* ===== APP STATE ===== */
const state = {
  docId:null, gids:{},
  contractorsCSV:null, propertyCSV:null,
  contractorNames:[], cities:[],
  contractorInfo:new Map(), // name -> {homeAddress?:string}
  routeSelections:new Map(), // name -> capacity
  dmCalls:0,
  // optimization
  tasks:[], // [{id, lat, lng, name, row, details, slack, listing, today, tomorrow, assignedTo?, distanceMeters?, durationSeconds?}]
  assignments:new Map(), // name -> Set(taskId), includes 'Unassigned'
  capacities:new Map(), // name -> capacity
  contractorMeta:new Map(), // name -> {homeAddress}
};

/* ===== BOOTSTRAP ===== */
async function bootstrap(){
  try{
    setStatus('Discovering tabs…');
    const pubhtml=document.getElementById('pubhtmlUrl').value.trim();
    const docId=extractDocIdFromPubhtml(pubhtml);
    state.docId=docId;
    const gids=await fetchGids(pubhtml);
    state.gids=gids;

    const getGid=(n)=>{
      const keys=Object.keys(gids);
      const exact=keys.find(k=>k===n) ?? keys.find(k=>k.toLowerCase()===n.toLowerCase());
      if(!exact) throw new Error(`Missing required tab "${n}"`);
      return gids[exact];
    };

    setStatus('Loading sheets…');
    const [contractorsCSV, propCSV] = await Promise.all([
      fetchCSVByGid(docId, getGid(SHEET_NAMES.CONTRACTORS)),
      fetchCSVByGid(docId, getGid(SHEET_NAMES.PROPERTY)),
    ]);
    state.contractorsCSV=contractorsCSV; state.propertyCSV=propCSV;

    // Contractor names from Contractors!D
    const colD = 3; // zero-based
    const names = contractorsCSV.slice(1).map(r=>r[colD]).filter(Boolean);
    const headerGuess = String((contractorsCSV[0]||[])[colD]||'').toLowerCase();
    const filtered = names.filter(n=> cleanName(n) && cleanName(n)!==cleanName(headerGuess) );
    state.contractorNames = [...new Set(filtered)].sort((a,b)=>String(a).localeCompare(String(b)));

    // Optional: home_address/address column
    const cHeader = contractorsCSV[0] || [];
    const cMap = getColumnMap(cHeader);
    const cHome = (cMap['home_address']!==undefined) ? cMap['home_address'] :
                  (cMap['address']!==undefined ? cMap['address'] : null);
    if(cHome!=null){
      for(const r of contractorsCSV.slice(1)){
        const name = r[colD];
        if(!name) continue;
        const addr = r[cHome];
        if(addr) state.contractorInfo.set(String(name), {homeAddress:String(addr)});
      }
    }

    // Cities from Property
    const pHeader=propCSV[0]; const pMap=getColumnMap(pHeader);
    const cCity=pMap['city']; if(cCity===undefined) throw new Error('Property tab missing "city" column');
    const cities=[...new Set(propCSV.slice(1).map(r=>r[cCity]).filter(Boolean).map(s=>String(s).trim().toLowerCase()))]
      .sort((a,b)=>a.localeCompare(b));
    state.cities=cities;

    // Fill selects
    fillSelect(document.getElementById('contractorSelect'), state.contractorNames, 'Select contractor…');
    fillSelect(document.getElementById('citySelect'), state.cities, 'Select city…');

    setStatus('Ready.');
  }catch(e){
    console.error(e); setStatus('Error: '+e.message);
  }
}
function fillSelect(el, values, placeholder){
  el.innerHTML='';
  const opt0=document.createElement('option'); opt0.value=''; opt0.textContent=placeholder; el.appendChild(opt0);
  values.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
}

/* ===== DISTANCE ===== */
const distCache=new Map();
async function getDistanceAndDuration(origin, lat, lng){
  const key=origin+'|'+lat+','+lng;
  if(distCache.has(key)) return distCache.get(key);
  if(!origin){ return null; }
  const url=`https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(origin)}&destinations=${encodeURIComponent(lat+','+lng)}&key=${encodeURIComponent(DIST_API_KEY)}`;
  const res=await fetch(url);
  const data=await res.json();
  const el=data?.rows?.[0]?.elements?.[0];
  if(data.status==='OK' && el?.status==='OK'){
    const out={distanceMeters:el.distance.value, durationSeconds:el.duration.value};
    distCache.set(key,out); state.dmCalls += 1; await sleep(50); return out;
  }
  return null;
}
function metersToMiles(m){ return (m/1609.344); }
function makeRouteLink(start, stops){
  if(!stops.length || !start) return '';
  const origin=encodeURIComponent(start);
  const dest=encodeURIComponent(`${stops[stops.length-1].lat},${stops[stops.length-1].lng}`);
  const waypts=stops.length>1?`&waypoints=${stops.slice(0,-1).map(t=>`${t.lat},${t.lng}`).join('|')}`:'';
  return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}${waypts}`;
}

/* ===== CAPACITY + BOARD HELPERS ===== */
function capacityInfo(name){
  const cap=state.capacities.get(name)||0;
  const used=(state.assignments.get(name)?.size)||0;
  const pct = cap>0 ? Math.min(100, Math.round((used/cap)*100)) : 0;
  return {cap, used, pct};
}
function updateCapacity(name, newCap){
  state.capacities.set(name, newCap);
  // If over capacity, spill furthest tasks to Unassigned
  const set = state.assignments.get(name) || new Set();
  if(set.size > newCap){
    // rank tasks by distance descending (furthest first)
    const tasks = [...set].map(id => state.tasks.find(t=>t.id===id)).filter(Boolean);
    tasks.sort((a,b)=> (b.distanceMeters||0) - (a.distanceMeters||0));
    const overflow = tasks.slice(newCap); // how many to remove
    const un = state.assignments.get('Unassigned') || new Set(); state.assignments.set('Unassigned', un);
    overflow.forEach(t=>{
      set.delete(t.id);
      t.assignedTo = undefined;
      un.add(t.id);
    });
  }
  renderBoard();
  renderTables(); // refresh tables/summary
  renderChart();
  document.getElementById('kpiAssigned').textContent=String(state.tasks.filter(x=>x.assignedTo).length);
}

/* ===== RENDER UI PIECES ===== */
function chipHTML(name, cap){
  const {used, pct} = capacityInfo(name);
  const maxSlider = Math.max(cap, used, 20); // reasonable headroom
  return `
    <div class="chip" data-chip="${name}">
      <div>
        <div style="font-weight:700">${name}</div>
        <div class="capline">
          <span class="muted">Capacity</span>
          <input type="range" min="0" max="${maxSlider}" step="1" value="${cap}" data-slider="${name}" />
          <output data-out="${name}">${cap}</output>
        </div>
        <div class="muted" style="font-size:12px; margin-top:6px;">Used: ${used}/${cap} (${cap>0?Math.round((used/cap)*100):0}%)</div>
      </div>
      <div class="right">
        <button class="btn" data-remove="${name}" title="Remove">✕</button>
      </div>
    </div>
  `;
}
function renderRouteChips(){
  const wrap=document.getElementById('selectedWrap'); wrap.innerHTML='';
  for(const [name, cap] of state.routeSelections.entries()){
    const div=document.createElement('div');
    div.innerHTML=chipHTML(name, cap);
    const node=div.firstElementChild;
    wrap.appendChild(node);
  }
  // wire sliders & remove
  wrap.querySelectorAll('input[type="range"][data-slider]').forEach(sl=>{
    sl.addEventListener('input', (e)=>{
      const name=e.target.getAttribute('data-slider');
      const out=wrap.querySelector(`output[data-out="${CSS.escape(name)}"]`);
      out.textContent = e.target.value;
    });
    sl.addEventListener('change', (e)=>{
      const name=e.target.getAttribute('data-slider');
      const val=parseInt(e.target.value,10);
      state.routeSelections.set(name, val);
      updateCapacity(name, val);
    });
  });
  wrap.querySelectorAll('button[data-remove]').forEach(btn=>{
    btn.onclick=()=>{
      const name=btn.getAttribute('data-remove');
      // move tasks back to Unassigned
      const set = state.assignments.get(name) || new Set();
      const un = state.assignments.get('Unassigned') || new Set(); state.assignments.set('Unassigned', un);
      [...set].forEach(id=>{
        set.delete(id);
        const t=state.tasks.find(x=>x.id===id); if(t){ t.assignedTo=undefined; un.add(id); }
      });
      state.assignments.delete(name);
      state.capacities.delete(name);
      state.routeSelections.delete(name);
      renderRouteChips(); renderBoard(); renderTables(); renderChart();
      document.getElementById('kpiAssigned').textContent=String(state.tasks.filter(x=>x.assignedTo).length);
    };
  });
}
function laneHTML(name, showMeter=true){
  const {cap, used, pct}=capacityInfo(name);
  const meter = showMeter ? `
    <div class="lane-hd">
      <div><b>${name}</b></div>
      <div class="cap">${used}/${cap}</div>
    </div>
    <div class="meter" aria-label="Capacity meter"><div class="fill" style="width:${pct}%"></div></div>
  ` : `
    <div class="lane-hd"><div><b>${name}</b></div><div class="cap">${used}</div></div>
  `;
  return `
    <div class="lane" data-contractor="${name}">
      ${meter}
      <div class="lane-body" style="margin-top:10px;"></div>
    </div>
  `;
}
function taskCardHTML(t){
  return `
    <div class="task" draggable="true" data-task="${t.id}">
      <div><b>${t.name || '(Unnamed property)'}</b></div>
      <div class="muted" style="font-size:12px;">Row ${t.row} • ${t.lat.toFixed(5)}, ${t.lng.toFixed(5)}</div>
      ${t.details ? `<div class="muted" style="font-size:12px; margin-top:4px;">${t.details}</div>` : ``}
      ${Number.isFinite(t.distanceMeters) ? `<div class="muted" style="font-size:12px; margin-top:4px;">~${metersToMiles(t.distanceMeters).toFixed(2)} mi • ${Math.ceil((t.durationSeconds||0)/60)} min</div>` : ``}
    </div>
  `;
}
function renderBoard(){
  const board=document.getElementById('board');
  board.innerHTML='';
  // Unassigned lane first
  const unDiv=document.createElement('div');
  unDiv.innerHTML=laneHTML('Unassigned', /*showMeter=*/false);
  const unLane=unDiv.firstElementChild;
  board.appendChild(unLane);

  // Contractor lanes
  for(const [name] of state.routeSelections.entries()){
    const wrap=document.createElement('div');
    wrap.innerHTML=laneHTML(name);
    board.appendChild(wrap.firstElementChild);
  }

  // Populate cards
  const placeInLane = (laneName, t) => {
    const lane = [...board.querySelectorAll('.lane')].find(l=>l.getAttribute('data-contractor')===laneName);
    lane.querySelector('.lane-body').insertAdjacentHTML('beforeend', taskCardHTML(t));
  };
  // Build lane sets default
  if(!state.assignments.has('Unassigned')) state.assignments.set('Unassigned', new Set());
  // Ensure every selected contractor has a set
  for(const [n] of state.routeSelections.entries()){
    if(!state.assignments.has(n)) state.assignments.set(n,new Set());
  }
  // Place tasks per assignments
  for(const t of state.tasks){
    const laneName = t.assignedTo ?? 'Unassigned';
    placeInLane(laneName, t);
  }

  // DnD handlers
  board.querySelectorAll('.lane').forEach(lane=>{
    lane.addEventListener('dragover', (e)=>{ e.preventDefault(); lane.classList.add('drop-target'); });
    lane.addEventListener('dragleave', ()=> lane.classList.remove('drop-target'));
    lane.addEventListener('drop', async (e)=>{
      e.preventDefault(); lane.classList.remove('drop-target');
      const tid=e.dataTransfer.getData('text/plain');
      const toName=lane.getAttribute('data-contractor');
      await moveTask(tid, toName);
    });
  });
  board.querySelectorAll('.task').forEach(el=>{
    el.addEventListener('dragstart', (e)=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', el.getAttribute('data-task')); });
    el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
  });
}

/* ===== MOVE / REASSIGN ===== */
async function moveTask(taskId, toName){
  const t=state.tasks.find(x=>x.id===taskId); if(!t) return;
  const fromName = t.assignedTo ?? 'Unassigned';

  if(toName !== 'Unassigned'){
    const cap = state.capacities.get(toName)||0;
    const used = (state.assignments.get(toName)?.size)||0;
    if(used >= cap){ alert(`Capacity reached for ${toName}`); return; }
  }

  // Remove from source
  const fromSet = state.assignments.get(fromName) || new Set(); fromSet.delete(taskId);

  if(toName === 'Unassigned'){
    t.assignedTo = undefined;
    const un = state.assignments.get('Unassigned') || new Set(); un.add(taskId); state.assignments.set('Unassigned', un);
  } else {
    // Recompute distance for new pairing
    const meta=state.contractorMeta.get(toName)||{};
    const dm=await getDistanceAndDuration(meta.homeAddress||'', t.lat, t.lng);
    if(dm){ t.distanceMeters=dm.distanceMeters; t.durationSeconds=dm.durationSeconds; }
    t.assignedTo = toName;
    const set = state.assignments.get(toName) || new Set(); set.add(taskId); state.assignments.set(toName, set);
  }

  renderBoard(); renderTables(); renderChart();
  document.getElementById('kpiAssigned').textContent=String(state.tasks.filter(x=>x.assignedTo).length);
}

/* ===== OPTIMIZATION ===== */
function nextId(){ return 't_'+Math.random().toString(36).slice(2,9); }

async function runOptimization(){
  try{
    setStatus('Optimizing…'); setProgress(0); state.dmCalls=0;
    // Reset containers but keep route selections
    state.tasks=[]; state.assignments.clear(); state.capacities.clear(); state.contractorMeta.clear();

    const citySel=document.getElementById('citySelect').value.trim().toLowerCase();
    const daySel=document.getElementById('daySelect').value;
    if(!citySel){ alert('Pick a city'); setStatus('Awaiting input'); return; }
    if(state.routeSelections.size===0){ alert('Add at least one contractor + capacity'); setStatus('Awaiting input'); return; }
    const hour = chicagoHourNow();

    // Capacities/meta from chips
    for(const [name, cap] of state.routeSelections.entries()){
      state.capacities.set(name, Number(cap)||0);
      const meta = state.contractorInfo.get(name) || {};
      state.contractorMeta.set(name, {homeAddress: meta.homeAddress || ''});
      state.assignments.set(name, new Set());
    }
    state.assignments.set('Unassigned', new Set());

    // Collect tasks from Property
    const pHeader=state.propertyCSV[0]; const pMap=getColumnMap(pHeader);
    const cLat=pMap['latitude'], cLng=pMap['longitude'], cCity=pMap['city'], cRepair=pMap['repair details'], cSlack=pMap['slack channel link'], cList=pMap['listing id'];
    const idxToday=14, idxTomorrow=15;
    const valid=[], unassign=[];
    for(let i=1;i<state.propertyCSV.length;i++){
      const row=state.propertyCSV[i];
      const lat=parseFloat(row[cLat]); const lng=parseFloat(row[cLng]);
      const rowCity=(row[cCity]||'').toString().trim().toLowerCase();
      const status=(row[(daySel==='today')?idxToday:idxTomorrow]||'').toString().trim();

      if(rowCity!==citySel || isNaN(lat)||isNaN(lng)||!status){ unassign.push(row); continue; }
      let ok=false;
      if(status==='Completely Vacant') ok=true;
      else if(status==='Vacant AFTER Check Out' && hour>=11) ok=true;
      else if(status==='Vacant BEFORE Check In' && hour<=13) ok=true;
      else if(status==='Turnover' && hour>=11 && hour<=15) ok=true;

      const task={ id:nextId(), row:i+1, lat, lng,
        name:row[5], details:row[cRepair], slack:row[cSlack], listing:row[cList],
        today:row[idxToday], tomorrow:row[idxTomorrow]
      };
      if(ok) valid.push(task); else unassign.push(row);
    }

    // Assign greedily to nearest with capacity & progress %
    const totalSteps = Math.max(1, valid.length);
    let done=0;
    for(const t of valid){
      let pick=null; let bestDist=Number.POSITIVE_INFINITY; let bestDur=0;
      for(const [name, set] of state.assignments.entries()){
        if(name==='Unassigned') continue;
        const cap=state.capacities.get(name)||0;
        if(set.size >= cap) continue;
        const meta=state.contractorMeta.get(name)||{};
        const dm=await getDistanceAndDuration(meta.homeAddress||'', t.lat, t.lng);
        const d=dm?.distanceMeters ?? Number.POSITIVE_INFINITY;
        if(d<bestDist){ pick=name; bestDist=d; bestDur=dm?.durationSeconds||0; }
      }
      if(pick){
        const set = state.assignments.get(pick); set.add(t.id);
        t.assignedTo=pick; t.distanceMeters=bestDist; t.durationSeconds=bestDur;
      } else {
        state.assignments.get('Unassigned').add(t.id);
      }
      state.tasks.push(t);
      done++; setProgress((done/totalSteps)*100);
    }

    // KPIs & pills
    document.getElementById('kpiTasks').textContent=String(valid.length);
    document.getElementById('kpiAssigned').textContent=String(state.tasks.filter(x=>x.assignedTo).length);
    document.getElementById('kpiUn').textContent=String(unassign.length);
    document.getElementById('kpiHM').textContent=String(state.routeSelections.size);
    document.getElementById('pillHour').textContent=String(hour).padStart(2,'0')+':00';
    document.getElementById('pillCity').textContent=citySel || '—';
    document.getElementById('pillDay').textContent=(daySel==='today'?'Today':'Tomorrow');
    document.getElementById('pillCalls').textContent=String(state.dmCalls);

    renderBoard(); renderTables(unassign); renderChart();

    // Downloads enable
    document.getElementById('dlOptimized').disabled=false;
    document.getElementById('dlSummary').disabled=false;
    document.getElementById('dlUnassignable').disabled=false;

    setStatus('Done.');
  }catch(e){
    console.error(e); setStatus('Error: '+e.message);
  }
}

/* ===== TABLES & CHART ===== */
function renderTables(unassignExplicit){
  // Optimized Assignments
  const optHeaders=['Contractor','Task Row','Property','Latitude','Longitude','Repair Details','Slack Channel Link','Listing ID','Today','Tomorrow'];
  const optRows=[];
  for(const t of state.tasks){
    if(!t.assignedTo) continue;
    optRows.push([t.assignedTo, t.row, t.name, t.lat, t.lng, t.details, t.slack, t.listing, t.today, t.tomorrow]);
  }
  table('optTable', optHeaders, optRows);

  // Distance Summary
  const sumHeaders=['Contractor','Total Distance (miles)','Total Duration (minutes)','Route Link'];
  const sumRows=[];
  for(const [name, set] of state.assignments.entries()){
    if(name==='Unassigned') continue;
    const ids=[...set]; const stops=ids.map(id=>state.tasks.find(t=>t.id===id && t.assignedTo===name)).filter(Boolean);
    const dSum=stops.reduce((a,t)=>a+(t.distanceMeters||0),0);
    const mSum=metersToMiles(dSum);
    const tSum=stops.reduce((a,t)=>a+(t.durationSeconds||0),0);
    const route=makeRouteLink((state.contractorMeta.get(name)||{}).homeAddress, stops);
    sumRows.push([name, mSum.toFixed(2), Math.ceil(tSum/60), route? `<a href="${route}" target="_blank">Open Route</a>`:'']);
  }
  table('sumTable', sumHeaders, sumRows);

  // Unassignable (from sheet rules)
  if(unassignExplicit){
    table('unTable', state.propertyCSV[0]||[], unassignExplicit);
  }

  // Downloads
  document.getElementById('dlOptimized').onclick=()=>downloadCSV('optimized_assignments.csv', optHeaders, optRows);
  const sumRowsPlain=sumRows.map(r=>[r[0], r[1], r[2], 'Open Route']);
  document.getElementById('dlSummary').onclick=()=>downloadCSV('distance_summary.csv', sumHeaders, sumRowsPlain);
  document.getElementById('dlUnassignable').onclick=()=>downloadCSV('unassignable_units.csv', state.propertyCSV[0]||[], unassignExplicit||[]);
}
function renderChart(){
  const wrap=document.getElementById('distChart');
  wrap.innerHTML='';
  const data=[];
  for(const [name, set] of state.assignments.entries()){
    if(name==='Unassigned') continue;
    const ids=[...set]; const miles = ids.reduce((a,id)=>{
      const t=state.tasks.find(x=>x.id===id);
      return a + (t?.distanceMeters ? metersToMiles(t.distanceMeters) : 0);
    },0);
    data.push({name, miles});
  }
  if(!data.length){ wrap.innerHTML='<div class="muted">No data</div>'; return; }
  const max=Math.max(...data.map(d=>d.miles),1);
  const barW=28, gap=18;
  data.forEach((d,i)=>{
    const h=Math.max(2, Math.round((d.miles/max)*((wrap.clientHeight||172)-22)));
    const x=i*(barW+gap)+12;
    const b=document.createElement('div');
    b.className='bar'; b.style.left=x+'px'; b.style.height=h+'px'; b.style.width=barW+'px';
    b.innerHTML=`<label>${d.miles.toFixed(1)}</label>`;
    b.title=`${d.name}: ${d.miles.toFixed(2)} mi`;
    wrap.appendChild(b);
  });
}

/* ===== UI WIRING ===== */
document.getElementById('addBtn').onclick=()=>{
  const name=document.getElementById('contractorSelect').value;
  const qty=parseInt(document.getElementById('qtyInput').value,10);
  if(!name){ alert('Select a contractor'); return; }
  if(!Number.isFinite(qty) || qty<0){ alert('Enter a capacity (0 or more)'); return; }
  state.routeSelections.set(name, qty);
  renderRouteChips();
  document.getElementById('contractorSelect').value='';
  document.getElementById('qtyInput').value='';
};
document.getElementById('resetBtn').onclick=()=>{
  state.routeSelections.clear(); renderRouteChips();
  document.getElementById('citySelect').value='';
  document.getElementById('daySelect').value='today';
  ['optTable','sumTable','unTable','distChart','board'].forEach(id=> document.getElementById(id).innerHTML='');
  ['kpiTasks','kpiAssigned','kpiUn','kpiHM'].forEach(id=> document.getElementById(id).textContent='—');
  ['pillHour','pillCity','pillDay','pillCalls'].forEach(id=> document.getElementById(id).textContent='—');
  setProgress(0); setStatus('Ready.');
};
document.getElementById('runBtn').onclick=()=>runOptimization();
document.getElementById('pubhtmlUrl').addEventListener('change', ()=>bootstrap());
window.addEventListener('load', ()=>bootstrap());
</script>
</body>
</html>
